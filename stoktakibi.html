<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Final Food List - CanlÄ±</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
/* CSS aynÄ±: mobil uyumlu, panel, item, badge vs. */
body { font-family:'Segoe UI',sans-serif; margin:0; padding:12px; background:#f9f9f9; color:#333; }
.panel { background:#fff; border-radius:10px; margin-bottom:14px; box-shadow:0 2px 6px rgba(0,0,0,0.08); padding:12px; }
.panel h3 { margin:6px 0; font-size:15px; color:#1976d2; }
.item { display:flex; align-items:center; justify-content: space-between; gap:10px; margin-bottom:10px; padding:6px 8px; border-radius:8px; background:#fdfdfd; }
.name { flex:1; font-size:13px; }
.badge { background:#eee; padding:2px 6px; border-radius:6px; font-size:11px; min-width:55px; text-align:center; }
.badge.critical { background:#e53935; color:white; }
input { width:45px; padding:4px; border:1px solid #ccc; border-radius:4px; text-align:center; font-size:12px;}
button { padding:10px; font-size:14px; border:none; cursor:pointer; transition:0.2s; color:white; border-radius:20px; background: linear-gradient(135deg, #42a5f5, #1976d2); box-shadow: 0 2px 4px rgba(0,0,0,0.2); display:flex; align-items:center; justify-content:center; gap:6px;}
button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.25); }
.top { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap: wrap; }
#total-label { font-size:14px; }
#total { font-weight:bold; font-size:18px; color:#388e3c; min-width:60px; text-align:right; }
.button-group { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.button-group button { flex:1; font-size:15px; padding:12px;}
#resetBtn { font-size:12px; padding:8px; }
/* Modal */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#fff; width:90%; max-width:600px; max-height:90%; overflow-y:auto; border-radius:10px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,0.2); position:relative; }
.modal-content h2 { margin-top:0; color:#000; } 
.close { position:absolute; top:10px; right:12px; cursor:pointer; font-size:18px; font-weight:bold; }
.order-card { background:#f7f7f7; border-radius:8px; margin-bottom:10px; padding:10px; color:#333; font-size:13px; }
.order-card ul { padding-left:20px; margin:4px 0; font-size:13px; }
.order-actions { display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
.order-label { font-weight:bold; color:#1976d2; }
.order-value { color:#333; font-weight:normal; }
.input-modal-content { background:#fff; width:90%; max-width:400px; border-radius:10px; padding:16px; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1500; box-shadow:0 2px 10px rgba(0,0,0,0.3); display:none; }
.input-modal-content h3 { margin-top:0; font-size:16px; }
.input-modal-content label { display:block; margin-top:8px; font-size:13px; font-weight:bold; color:#1976d2; }
.input-modal-content input { width:100%; padding:6px; margin-top:4px; border:1px solid #ccc; border-radius:6px; }
.input-modal-content button { margin-top:10px; width:100%; }
</style>
</head>
<body>
<div class="top">
  <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
    <div id="total-label">Sepet ToplamÄ±: <span id="total">0</span></div>
    <button id="resetBtn" onclick="resetAll()">ðŸ§¹ Temizle</button>
  </div>
</div>
<div id="list"></div>
<div class="button-group">
  <button onclick="prepareSend()">ðŸ“¨ GÃ¶nder</button>
  <button onclick="toggleSepet()">ðŸ›’ Sepet</button>
</div>

<div id="sepetModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="toggleSepet()">&times;</span>
    <h2>Sepet</h2>
    <div id="historySection"></div>
  </div>
</div>

<div id="sendModal" class="input-modal-content">
  <h3>GÃ¶nderilecek Bilgiler</h3>
  <label>Oyuncu Etiketi:</label>
  <input type="text" id="playerName">
  <label>Ã‡iftlik AdÄ±:</label>
  <input type="text" id="farmName">
  <button onclick="sendAll()">GÃ¶nder</button>
</div>

<script>
const START=50;
const data={"TatlÄ±lar":["Affogato","Bonbon","Fudge","Karamelli Elma","Muzlu TatlÄ±","Rulo Pasta","SÃ¼slÃ¼ Pasta","Meyveli Pasta","Ã‡.Meyveli Turta","Ã‡ikolatalÄ± Turta","MantarlÄ± Turta","Åžeftalili Turta","Yaban Mersinli Kek","Y.Mersinli Chesecake","Zencefilli Kurabiye","Ã‡Ä±tÄ±r Donut","KremalÄ± Donut","Sade Donut","Åžekerli Donut"],"ReÃ§eller":["Ahududu ReÃ§eli","BÃ¶ÄŸÃ¼rtlen ReÃ§eli","Ã‡.Meyve ReÃ§eli","Ã‡ilek ReÃ§eli","Elma ReÃ§eli","Erik ReÃ§eli","Åžeftali ReÃ§eli","ÃœzÃ¼m ReÃ§eli","ViÅŸne ReÃ§eli","Y.Mersin ReÃ§eli","Åžeftali ReÃ§eli"]};

/* --- Firebase config --- */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let state = {}; // local cache
let history = [];

// Build panel
function build(){
  const list=document.getElementById("list"); list.innerHTML="";
  for(const cat in data){
    const panel=document.createElement("div"); panel.className="panel";
    panel.innerHTML=`<h3>${cat}</h3>`; list.appendChild(panel);
    data[cat].forEach(name=>{
      const remain = state[name]?.remain ?? START;
      const badgeClass = remain <=5?"badge critical":"badge";
      const row=document.createElement("div"); row.className="item";
      row.innerHTML=`<div class="name">${name}</div><div class="${badgeClass}" id="r-${name}">Kalan: ${remain}</div><input type="number" min="0" id="i-${name}" placeholder="0" oninput="liveUpdate('${name}')">`;
      list.appendChild(row);
    });
  }
  updateTotal();
}

function liveUpdate(name){
  const inp=document.getElementById("i-"+name);
  let val=Number(inp.value||0);
  const remain = state[name]?.remain ?? START;
  if(val>remain){
    alert(`${name} iÃ§in stok miktarÄ±nÄ± aÅŸtÄ±nÄ±z!`);
    inp.value = remain;
    val = remain;
  }
  document.getElementById("r-"+name).textContent="Kalan: "+(remain-val);
  updateTotal();
}

function updateTotal(){
  let sum=0;
  for(const cat in data){ data[cat].forEach(n=>{ sum+=Number(document.getElementById("i-"+n).value||0); }); }
  document.getElementById("total").textContent=sum;
}

function prepareSend(){
  let has=false;
  for(const cat in data){ data[cat].forEach(n=>{ if(Number(document.getElementById("i-"+n).value||0)>0) has=true; }); }
  if(!has){ alert("SipariÅŸ iÃ§in Ã¼rÃ¼n seÃ§mediniz."); return; }
  document.getElementById("sendModal").style.display="block";
}

function sendAll(){
  const player=document.getElementById("playerName").value.trim();
  const farm=document.getElementById("farmName").value.trim();
  if(!player||!farm){ alert("Oyuncu ve Ã‡iftlik adÄ±nÄ± giriniz."); return; }

  const orderItems=[];
  for(const cat in data){ data[cat].forEach(name=>{
    const val = Number(document.getElementById("i-"+name).value||0);
    if(val>0) orderItems.push({name,qty:val});
  }); }

  if(orderItems.length===0){ alert("SipariÅŸ iÃ§in Ã¼rÃ¼n seÃ§mediniz."); return; }

  const now = new Date();
  const tarih = now.toLocaleDateString("tr-TR");
  const saat = now.toLocaleTimeString("tr-TR");

  // Firestore kaydet
  orderItems.forEach(item=>{
    const ref = db.collection("stoklar").doc(item.name);
    db.runTransaction(async (t)=>{
      const doc = await t.get(ref);
      const remain = doc.exists ? doc.data().remain : START;
      if(item.qty>remain) throw "Stok yetersiz: "+item.name;
      t.set(ref, {remain:remain-item.qty, sold:(doc.data()?.sold||0)+item.qty});
    });
  });

  db.collection("siparisler").add({
    player, farm, tarih, saat, items:orderItems, done:false
  }).then(()=>{ alert("SipariÅŸ tamamlandÄ±!"); build(); toggleSepet(); });
}

// Sepet modal
function toggleSepet(){
  const modal=document.getElementById("sepetModal");
  modal.style.display = modal.style.display==="flex"?"none":"flex";
  if(modal.style.display==="flex") renderSepet();
}

function renderSepet(){
  const histDiv=document.getElementById("historySection"); histDiv.innerHTML="";
  db.collection("siparisler").get().then(snap=>{
    if(snap.empty){ histDiv.innerHTML="<p>HenÃ¼z sipariÅŸ yok.</p>"; return; }
    snap.forEach(doc=>{
      const ord=doc.data();
      const card=document.createElement("div"); card.className="order-card";
      card.innerHTML=`
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <div><span class="order-label">Oyuncu Etiketi:</span> <span class="order-value">${ord.player}</span></div>
            <div><span class="order-label">Ã‡iftlik AdÄ±:</span> <span class="order-value">${ord.farm}</span></div>
            <div><span class="order-label">Tarih:</span> <span class="order-value">${ord.tarih} ${ord.saat}</span></div>
            <div><span class="order-label">ÃœrÃ¼nler:</span></div>
            <ul>${ord.items.map(it=>`<li>${it.name} â€” ${it.qty} adet</li>`).join('')}</ul>
          </div>
        </div>
      `;
      histDiv.appendChild(card);
    });
  });
}

build();
</script>
</body>
</html>
